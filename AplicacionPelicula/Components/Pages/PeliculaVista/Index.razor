@page "/Index"
@using AplicacionPelicula.Servicios
@inject PeliculaService PeliculaService
@inject NavigationManager NavigationManager

<style>
    body, .page {
        background-color: #121212 !important; /*fondo oscuro global*/
        color: #fff;
        margin: 0;
        padding: 0;
    }

    .form-container {/*formulario*/
        background-color: #1c1c1c;
        color: #fff;
        padding: 20px;
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.6);
        max-width: 400px;
        margin: 20px auto;
    }

    .form-title {
        margin-bottom: 15px;
        font-size: 1.5rem;
        color: #f1c40f;
        text-align: center;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-input {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: none;
        background-color: #333;
        color: #fff;
    }

        .form-input:focus {
            outline: none;
            border: 2px solid #f1c40f;
        }

    .button-group {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
    }

    .btn-yellow {
        background-color: #f1c40f;
        border: none;
        color: #000;
        padding: 10px 15px;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
    }

    .btn-gray {
        background-color: #555;
        border: none;
        color: #fff;
        padding: 10px 15px;
        border-radius: 8px;
        cursor: pointer;
    }

    .btn-yellow:hover {
        background-color: #d4ac0d;
    }

    .btn-gray:hover {
        background-color: #444;
    }

    .mensaje {
        margin-top: 10px;
        text-align: center;
        font-size: 0.9rem;
    }

        .mensaje.exito {
            color: #2ecc71; 
        }

        .mensaje.error {
            color: #e74c3c; 
        }

        .mensaje.info {
            color: #f1c40f; 
        }
</style>

<div class="form-container">
    <h3 class="form-title">Nueva Película</h3>

    <div class="form-group">
        <label>Título</label>
        <input type="text" @bind="miPelicula.Titulo" class="form-input" />
    </div>

    <div class="form-group">
        <label>Género</label>
        <select @bind="miPelicula.Genero" class="form-input">
            <option value="">Seleccione un género</option>
            <option value="Accion">Acción</option>
            <option value="Comedia">Comedia</option>
            <option value="Drama">Drama</option>
        </select>
    </div>

    <div class="form-group">
        <label>Año</label>
        <input type="number" @bind="miPelicula.Anio" class="form-input" />
    </div>

    <div class="form-group">
        <label>Descripción</label>
        <textarea @bind="miPelicula.Descripcion" class="form-input"></textarea>
    </div>

    <div class="form-group">
        <label>Imagen</label>
        <div style="display:flex; gap:10px; align-items:center;">
            <input type="text" @bind="miPelicula.ImagenRuta" class="form-input" placeholder="Ruta de la imagen..." />
            <button type="button" class="btn-yellow" @onclick="AbrirSelectorImagen">Agregar Imagen</button>
        </div>
        @if (!string.IsNullOrWhiteSpace(miPelicula.ImagenRuta))
        {
            <img src="@miPelicula.ImagenRuta" alt="Imagen de @miPelicula.Titulo"
                 onerror="this.onerror=null;this.src='images/default.jpg';"
                 class="preview-img" />
        }
    </div>

    <div class="button-group">
        <button class="btn-yellow" @onclick="CrearPelicula" disabled="@estaGuardando">
            @(estaGuardando ? "Guardando..." : "Agregar Película")
        </button>
        <button class="btn-gray" @onclick="VolverAlMenu">Volver al menú</button>
    </div>

    <p class="mensaje @tipoMensaje">@mensaje</p>
</div>

@code {
    Modelos.Pelicula miPelicula = new Modelos.Pelicula();
    string mensaje = string.Empty;
    string tipoMensaje = "info";
    bool estaGuardando = false;

    public async Task CrearPelicula()
    {
        if (estaGuardando) return;

        if(string.IsNullOrWhiteSpace(miPelicula.Titulo) || //hago una validacion manual de campos obligatorios
           string.IsNullOrWhiteSpace(miPelicula.Genero) ||
           string.IsNullOrWhiteSpace(miPelicula.Descripcion) ||
           string.IsNullOrWhiteSpace(miPelicula.ImagenRuta))
        {
            mensaje = "por favor complete todos los campos obligatorios";
            tipoMensaje = "error";
            return;
        }

        estaGuardando = true;
        try
        {
            await PeliculaService.AgregarPeliculaAsync(miPelicula);//guarda la peliucla en la db
            mensaje = "pelicula guardada";
            tipoMensaje = "exito";
            miPelicula = new Modelos.Pelicula();//resete el form
        }
        catch(Exception ex)
        {
            mensaje = $"error al guardar pelicula: {ex.Message}";
            tipoMensaje = "error";
        }
        finally
        {
            estaGuardando = false;
        }
    }

    void VolverAlMenu()
    {
        NavigationManager.NavigateTo("/Menu");
    }

    private async Task AbrirSelectorImagen()
    {
        try
        {
            var pickOptions = new PickOptions//pido elegir solo imagenes
            {
                PickerTitle = "Seleccionar imagen",
                FileTypes = FilePickerFileType.Images
            };

            var result = await FilePicker.PickAsync(pickOptions);
            if (result == null) return;

            var nombreArchivo = $"{Guid.NewGuid()}{Path.GetExtension(result.FileName)}";//genero nombre unico para evitar colisiones
            

            //miPelicula.ImagenRuta = $"/Imagenes/imgPeliculas/{nombreArchivo}";
            await using var stream = await result.OpenReadAsync();
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            var base64 = Convert.ToBase64String(ms.ToArray());//transformo bytes en cadena legible (html, json, etc)
            var extension = Path.GetExtension(result.FileName).ToLowerInvariant();
            var mimeType = extension switch //uso el switch para asignar el mime segun extension del archivo
            {
                ".jpg" or ".jpeg" => "image/jpeg",
                ".png" => "image/png",
                ".gif" => "image/gif",
                _ => "application/octet-stream"
            };
            miPelicula.ImagenRuta = $"data:{mimeType};base64,{base64}";
            mensaje = $"Imagen seleccionada: {nombreArchivo}";
            tipoMensaje = "info";
        }
        catch (Exception ex)
        {
            mensaje = $"Error al seleccionar imagen: {ex.Message}";
            tipoMensaje = "error";
        }
    }
    //uso await using para asegurarme que los streams se cierren correctamente
    //verifico con File.Exists() para confirmar que la imagen fue realmente copiada
}